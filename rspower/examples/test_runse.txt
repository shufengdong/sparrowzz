#include ../data/case3bus_P6_6.txt
#include ../lib/idx_gen.txt
#include ../lib/idx_bus.txt
#include ../lib/idx_brch.txt
#include ../lib/ext2int.txt
#include ../lib/int2ext.txt
#include ../lib/bustypes.txt
#include ../lib/make_y_bus.txt
#include ../lib/getV0.txt
#include ../lib/runse.txt
#include ../lib/dSbr_dV.txt
#include ../lib/dSbus_dV.txt
#include ../lib/doSE.txt
#include ../lib/isobservable.txt
#include ../lib/make_sdzip.txt
#include ../lib/make_sbus.txt
#include ../lib/pfsoln.txt
#include ../lib/total_load.txt

//输入观测值
// which measurements are available
idx_zPF = [[1],[2]];
idx_zPT = [3];
idx_zPG = [[1],[2],[3]];
idx_zVa = [];
idx_zQF = [];
idx_zQT = [];
idx_zQG = [];
idx_zVm = [[2],[3]];

// specify measurements
measure_PF = [[0.12],[0.10]];
measure_PT = [-0.04];
measure_PG = [[0.58],[0.30],[0.14]];
measure_Va = [];
measure_QF = [];
measure_QT = [];
measure_QG = [];
measure_Vm = [[1.04],[0.98]];

// specify measurement variances
sigma_PF = 0.02;
sigma_PT = 0.02;
sigma_PG = 0.015;
sigma_Va = [];
sigma_QF = [];
sigma_QT = [];
sigma_QG = [];
sigma_Vm = 0.01;

type_initialguess = 2;
V0 = [[1], [1.02], [1.02]];

[baseMVA, bus, gen, branch, success, z, z_est, error_sqrsum] = run_se(type_initialguess, V0);

assert_relative_eq(baseMVA, 1000);

assert_relative_eq(bus, [
    [1, 3, 350, 100, 0, 0, 1, 1, 0, 230, 1, 1, 1],
    [2, 2, 400, 250, 0, 0, 1, 1.0258, -0.9748, 230, 1, 1.02, 1.02],
    [3, 2, 250, 100, 0, 0, 1, 0.9790, 0.0415, 230, 1, 1.02, 1.02]
], 0.001);

assert_relative_eq(gen, [
    [1, 575.7215, -37.5179, 999, -999, 1, 100, 1, 600, 0],
    [2, 303.4183, 946.8882, 999, -999, 1.02, 100, 1, 400, 0],
    [3, 133.5777, -527.2488, 999, -999, 1.02, 100, 1, 100, 0]
], 0.001);

assert_relative_eq(branch, [
    [1, 2, 0.01, 0.1, 0.05, 999, 100, 100, 0, 0, 1, 147.4384, -295.7713, -146.4878, 253.9727],
    [1, 3, 0.05, 0.1, 0.025, 999, 100, 100, 0, 0, 1, 78.2831, 158.2534, -76.5189, -179.2057],
    [2, 3, 0.05, 0.1, 0.025, 999, 100, 100, 0, 0, 1, 49.9061, 442.9156, -39.9035, -448.0432]
], 0.001);

assert_relative_eq(success, 1);

assert_relative_eq(z, [
    [0.1200],
    [0.1000],
    [-0.0400],
    [0.5800],
    [0.3000],
    [0.1400],
    [1.0400],
    [0.9800]
]);

assert_relative_eq(z_est, [
    [0.1474],
    [0.0783],
    [-0.0399],
    [0.5757],
    [0.3034],
    [0.1336],
    [1.0258],
    [0.9790]
], 0.001);

assert_relative_eq(error_sqrsum, c(5.4179,-4.7371e-16), 0.001);