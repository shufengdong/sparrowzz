#include ../data/case3bus_P6_6.txt
#include ../lib/idx_gen.txt
#include ../lib/idx_bus.txt
#include ../lib/idx_brch.txt
#include ../lib/make_y_bus.txt
#include ../lib/dSbr_dV.txt

V = [[1], [1.02], [1.02]];
[Ybus, Yf, Yt] = make_y_bus(baseMVA, bus, branch);
vcart = 0;

[dSf_dV1, dSf_dV2, dSt_dV1, dSt_dV2, Sf, St] = dSbr_dV(branch, Yf, Yt, V, vcart);

assert_relative_eq(dSf_dV1, [
    [c(10.0990, -1.0099), c(-10.0990, 1.0099), c(0,0)],
    [c(8.1600, -4.0800), c(0, 0), c(-8.1600, 4.0800)],
    [c(0, 0), c(8.3232, -4.1616), c(-8.3232, 4.1616)]
],0.001);

assert_relative_eq(dSf_dV2, [
    [c(0.9703, 9.6530), c(-0.9901, -9.9010), c(0,0)],
    [c(3.9200, 7.8150), c(0, 0), c(-4.0000, -8.0000)],
    [c(0, 0), c(4.0800, 8.1345), c(-4.0800, -8.1600)]
],0.001);

assert_relative_eq(dSt_dV1, [
    [c(-10.0990, 1.0099), c(10.0990, -1.0099), c(0,0)],
    [c(-8.1600, 4.0800), c(0, 0), c(8.1600, -4.0800)],
    [c(0, 0), c(-8.3232, 4.1616), c(8.3232, -4.1616)]
],0.001);

assert_relative_eq(dSt_dV2, [
    [c(-1.0099, -10.0990), c(1.0297, 10.2460), c(0,0)],
    [c(-4.0800, -8.1600), c(0, 0), c(4.1600, 8.2945)],
    [c(0, 0), c(-4.0800, -8.1600), c(4.0800, 8.1345)]
],0.001);

assert_relative_eq(Sf, [
    [c(-0.0198, -0.2230)],
    [c(-0.0800, -0.1725)],
    [c(-4.4391e-16, -0.0130)]
],0.001);

assert_relative_eq(St, [
    [c(0.0202,0.1760)],
    [c(0.0816,0.1502)],
    [c(4.4391e-16, -0.0130)]
],0.001);
